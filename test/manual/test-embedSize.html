<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test embedSize Event</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 20px;
    }
    #embed-container {
      width: 100%;
      border: 1px solid #ccc;
    }
    #embed-container iframe {
      display: block; /* Remove inline spacing */
    }
    #log {
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    .controls {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .controls-group {
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 4px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .controls-group label {
      font-weight: bold;
      font-size: 12px;
      color: #666;
    }
    button {
      padding: 8px 16px;
    }
    button.active {
      background: #4CAF50;
      color: white;
    }
    .size-info {
      margin-bottom: 15px;
      padding: 10px;
      background: #e8f4e8;
      border-radius: 4px;
      font-family: monospace;
    }
    .mode-info {
      margin-bottom: 15px;
      padding: 10px;
      background: #e8e8f4;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>embedSize Event Test</h1>

  <div class="controls">
    <div class="controls-group">
      <label>Actions:</label>
      <button onclick="clearLog()">Clear Log</button>
      <button onclick="location.reload()">Reload</button>
    </div>
    <div class="controls-group">
      <label>Width:</label>
      <button onclick="resizeContainer(600)">600px</button>
      <button onclick="resizeContainer(800)">800px</button>
      <button onclick="resizeContainer('100%')">100%</button>
    </div>
    <div class="controls-group">
      <label>Layout:</label>
      <button onclick="switchMode('responsive')" id="btn-responsive">Responsive</button>
      <button onclick="switchMode('page')" id="btn-page">Page</button>
      <button onclick="switchMode('track')" id="btn-track">Track</button>
    </div>
    <div class="controls-group">
      <label>Display:</label>
      <button onclick="switchDisplay(false)" id="btn-old-display">Old</button>
      <button onclick="switchDisplay(true)" id="btn-new-display">New</button>
    </div>
  </div>

  <div class="mode-info" id="mode-info">
    Mode: loading...
  </div>

  <div class="size-info" id="size-info">
    Iframe size: waiting for embedSize event...
  </div>

  <div id="embed-container"></div>

  <h3>Event Log:</h3>
  <div id="log"></div>

  <script src="../../dist/flat-embed.mjs" type="module"></script>
  <script type="module">
    import Embed from '../../dist/flat-embed.mjs';

    const log = document.getElementById('log');
    const sizeInfo = document.getElementById('size-info');
    const modeInfo = document.getElementById('mode-info');
    const container = document.getElementById('embed-container');

    // Get params from URL
    const urlParams = new URLSearchParams(window.location.search);
    const layout = urlParams.get('layout') || 'responsive';
    const newDisplay = urlParams.get('newDisplay') === 'true';

    // Update mode info
    modeInfo.textContent = `Layout: ${layout} | Display: ${newDisplay ? 'new' : 'old'}`;

    // Highlight active buttons
    document.getElementById(`btn-${layout}`)?.classList.add('active');
    document.getElementById(newDisplay ? 'btn-new-display' : 'btn-old-display')?.classList.add('active');

    function addLog(message) {
      const time = new Date().toLocaleTimeString();
      log.textContent += `[${time}] ${message}\n`;
      log.scrollTop = log.scrollHeight;
    }

    window.clearLog = function() {
      log.textContent = '';
    };

    window.resizeContainer = function(width) {
      const widthStr = typeof width === 'number' ? `${width}px` : width;
      container.style.width = widthStr;
      addLog(`Container width set to ${widthStr}`);
    };

    window.switchMode = function(newLayout) {
      const params = new URLSearchParams(window.location.search);
      params.set('layout', newLayout);
      window.location.search = params.toString();
    };

    window.switchDisplay = function(useNew) {
      const params = new URLSearchParams(window.location.search);
      params.set('newDisplay', useNew ? 'true' : 'false');
      window.location.search = params.toString();
    };

    addLog(`Creating embed with layout=${layout}, newDisplay=${newDisplay}...`);

    const embedParams = {
      appId: '58f0ee6053674e68c81e5646',
      controlsFloating: false,
      layout: layout,
    };

    if (newDisplay) {
      embedParams['newDisplay'] = true;
    }

    const embed = new Embed('embed-container', {
      score: '56ae21579a127715a02901a6',
      // score: '655421147ae4155c831a5dbe',
      // baseUrl: 'https://flat.ovh:3000/embed',
      embedParams: embedParams
    });

    // Listen for ready
    embed.ready().then(() => {
      addLog('Embed ready!');
    });

    // Listen for scoreLoaded
    embed.on('scoreLoaded', () => {
      addLog('scoreLoaded event received');
    });

    // Listen for embedSize and auto-resize iframe height
    embed.on('embedSize', (data) => {
      addLog(`embedSize: ${data.width}px × ${data.height}px`);

      // Set iframe height to match content - no scrollbars!
      embed.element.style.height = `${data.height}px`;

      sizeInfo.textContent = `Iframe size: ${data.width}px × ${data.height}px (auto-adjusted)`;
    });

    addLog('Event listeners registered, waiting for events...');
  </script>
</body>
</html>
